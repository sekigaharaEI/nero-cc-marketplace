# daemon-archon å¼€å‘è®¾è®¡æ–‡æ¡£

> æœ¬æ–‡æ¡£è®°å½•å¼€å‘è¿‡ç¨‹ä¸­çš„è®¾è®¡å†³ç­–å’ŒæŠ€æœ¯ç»†èŠ‚

---

## ä¸€ã€æ¶æ„è§’è‰²å®šä¹‰

æœ¬æ’ä»¶æ¶‰åŠä¸‰ä¸ªæ ¸å¿ƒè§’è‰²ï¼š

### 1.1 Claude Code ç»ˆç«¯

**å®šä½**ï¼šåŸºç¡€æ‰§è¡Œç¯å¢ƒ

- åŸºäº Claude Code æ‰èƒ½åŠ è½½æ’ä»¶ã€skillsã€commands
- ä½œä¸ºæ™ºèƒ½ä½“å®Œæˆä¸€ç³»åˆ—å¤æ‚çš„åŸå­æ“ä½œ
- åŸºäºæç¤ºè¯å®ç°ä»£ç ç¼–å†™ã€åŠŸèƒ½è°ƒç”¨ç­‰ä»»åŠ¡

### 1.2 Archonï¼ˆæ‰§æ”¿å®˜ï¼‰

**å®šä½**ï¼šä»»åŠ¡è°ƒåº¦å™¨

åŸºäº cron å®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼Œåˆ†ä¸ºä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š

#### Probe æ¨¡å¼
- æ–°å»ºä¸€ä¸ª Claude Code CLIï¼ˆProbeï¼‰æ‰§è¡Œç”¨æˆ·ç‰¹å®šçš„é•¿æœŸä»»åŠ¡
- Archon å®šæ—¶åŸºäºé¢„è®¾æ¨¡æ¿ï¼Œåˆ†æ Probe çš„æ‰§è¡Œæƒ…å†µ
- åˆ†æç»´åº¦ï¼šäº§ç‰©ã€æ—¥å¿—ã€å¯¹è¯è®°å½•ã€å·¥å…·è°ƒç”¨ç­‰
- å¯å¯¹ Probe è¿›è¡Œçº åï¼ˆæ³¨å…¥æ–°æç¤ºè¯æ¥ç»­å¯¹è¯ï¼‰

#### Cron æ¨¡å¼
- Archon æ ¹æ® cron å®šæ—¶å¯åŠ¨ä¸€ä¸ª**ä¸´æ—¶** Claude Code CLI
- æŒ‰ç…§ workflow ä¸­çš„å·¥ä½œæ¸…å•é€ä¸ªè°ƒç”¨å¹¶æ±‡æ€»ç›‘æ§
- å¦‚æœ‰å¼‚å¸¸åˆ™å‘é€ç³»ç»Ÿé€šçŸ¥
- æ¯æ¬¡æ‰§è¡Œå®Œæ¯•åä¸´æ—¶ä¼šè¯é”€æ¯

### 1.3 Probeï¼ˆæ¢æœºï¼‰

**å®šä½**ï¼šæ‰§è¡Œå±‚è§’è‰²

- åŸºäº Claude Code CLI æ¨¡å¼è¿è¡Œ
- è´Ÿè´£æ¥å— Archon çš„è°ƒåº¦
- Archon å¯éšæ—¶åœæ­¢ Probe è¿›ç¨‹
- Archon å¯éšæ—¶è¾“å…¥æ–°æç¤ºè¯è¿›è¡Œæ¥ç»­å¯¹è¯ï¼ˆçº åï¼‰

---

## äºŒã€å·¥ä½œç›®å½•è®¾è®¡

### 2.1 ç›®å½•ç»“æ„ï¼ˆå·²ç¡®å®šï¼‰

**æ ¹ç›®å½•**ï¼š`.claude/daemon-archon/`

```
.claude/daemon-archon/
â”œâ”€â”€ setting.json                          # å…¨å±€é…ç½®ï¼ˆé€šçŸ¥æ–¹å¼ç­‰ï¼‰
â”œâ”€â”€ 20260201_143000_probe/                # Probe ä»»åŠ¡ç›®å½•ï¼ˆæ—¶é—´æˆ³+æ¨¡å¼åç¼€ï¼‰
â”‚   â”œâ”€â”€ config.json                       # ä»»åŠ¡é…ç½®
â”‚   â”œâ”€â”€ status                            # çŠ¶æ€æ–‡ä»¶ï¼ˆactive/stopped/pausedï¼‰
â”‚   â”œâ”€â”€ task.lock                         # ä»»åŠ¡çº§é”æ–‡ä»¶ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
â”‚   â”œâ”€â”€ destination.md                    # ä»»åŠ¡ç›®æ ‡ï¼ˆArchon éªŒè¯å®Œæˆçš„ä¾æ®ï¼‰
â”‚   â”œâ”€â”€ corrections.md                    # çº åå†å²ï¼ˆMarkdown æ ¼å¼ï¼‰
â”‚   â””â”€â”€ archon.log                        # å·¥ä½œæ—¥å¿—ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
â”‚
â””â”€â”€ 20260201_150000_cron/                 # Cron ä»»åŠ¡ç›®å½•ï¼ˆæ—¶é—´æˆ³+æ¨¡å¼åç¼€ï¼‰
    â”œâ”€â”€ config.json                       # ä»»åŠ¡é…ç½®
    â”œâ”€â”€ status                            # çŠ¶æ€æ–‡ä»¶ï¼ˆactive/stopped/pausedï¼‰
    â”œâ”€â”€ task.lock                         # ä»»åŠ¡çº§é”æ–‡ä»¶ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
    â”œâ”€â”€ task.md                           # ä»»åŠ¡æè¿°/æç¤ºè¯/èƒŒæ™¯/ç‰¹åˆ«è¯´æ˜
    â”œâ”€â”€ workflow/                         # Workflow å­æ–‡ä»¶å¤¹
    â”‚   â”œâ”€â”€ workflow.md                   # å·¥ä½œæµç¨‹å®šä¹‰
    â”‚   â””â”€â”€ scripts/                      # è„šæœ¬ä»£ç ï¼ˆå¯é€‰ï¼‰
    â”‚       â””â”€â”€ check_xxx.sh
    â””â”€â”€ archon.log                        # å·¥ä½œæ—¥å¿—ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
```

### 2.2 æ–‡ä»¶è¯´æ˜

#### é€šç”¨æ–‡ä»¶

| æ–‡ä»¶ | æ ¼å¼ | è¯´æ˜ |
|------|------|------|
| `setting.json` | JSON | å…¨å±€é…ç½®ï¼šé€šçŸ¥æ–¹å¼ç­‰ |
| `status` | çº¯æ–‡æœ¬ | ä»»åŠ¡çŠ¶æ€ï¼š`active` / `stopped` / `paused` |
| `task.lock` | é”æ–‡ä»¶ | ä»»åŠ¡çº§é”ï¼Œé˜²æ­¢åŒä¸€ä»»åŠ¡è¢«å¹¶å‘å¤„ç† |
| `archon.log` | æ—¥å¿— | Archon è¡ŒåŠ¨æ—¥å¿—ï¼Œæ¯æ¡å¸¦æ—¶é—´æˆ³ |

#### Probe æ¨¡å¼ä¸“å±

| æ–‡ä»¶ | æ ¼å¼ | è¯´æ˜ |
|------|------|------|
| `config.json` | JSON | ä»»åŠ¡ IDã€Probe ä¼šè¯ IDã€æ£€æŸ¥é—´éš”ç­‰ |
| `destination.md` | Markdown | ä»»åŠ¡ç›®æ ‡ï¼ŒArchon ç”¨äºéªŒè¯ Probe æ˜¯å¦å®Œæˆä»»åŠ¡ |
| `corrections.md` | Markdown | çº åå†å²ï¼šæ—¶é—´ã€åŸå› ã€æŒ‡ä»¤ã€ç»“æœã€çº åè€…ï¼ˆArchon/äººï¼‰ |

#### Cron æ¨¡å¼ä¸“å±

| æ–‡ä»¶ | æ ¼å¼ | è¯´æ˜ |
|------|------|------|
| `config.json` | JSON | ä»»åŠ¡ IDã€æ‰§è¡Œé—´éš”ç­‰ |
| `task.md` | Markdown | ä»»åŠ¡æè¿°ã€æç¤ºè¯ã€èƒŒæ™¯ã€ç‰¹åˆ«è¯´æ˜ |
| `workflow/workflow.md` | Markdown | å·¥ä½œæµç¨‹å®šä¹‰ |
| `workflow/scripts/` | è„šæœ¬ | å¯é€‰çš„è„šæœ¬ä»£ç  |

### 2.3 æ—¥å¿—æ ¼å¼è§„èŒƒ

`archon.log` æ¯æ¡æ—¥å¿—æ ¼å¼ï¼š
```
[2026-02-01 14:30:00] [ACTION] è§¦å‘å®šæ—¶æ£€æŸ¥
[2026-02-01 14:30:01] [INPUT] è¯»å– Probe transcript...
[2026-02-01 14:30:05] [OUTPUT] åˆ†æç»“æœï¼šä»»åŠ¡è¿›åº¦ 60%ï¼Œæ— å¼‚å¸¸
[2026-02-01 14:30:05] [DECISION] æ— éœ€çº åï¼Œç»§ç»­ç›‘æ§
```

### 2.4 çŠ¶æ€æ–‡ä»¶è¯´æ˜

`status` æ–‡ä»¶å†…å®¹ä¸ºå•è¡Œæ–‡æœ¬ï¼š
- `active` - ä»»åŠ¡å¯ç”¨ä¸­
- `stopped` - ä»»åŠ¡å·²åœæ­¢
- `paused` - ä»»åŠ¡æš‚åœä¸­

---

## å¾…è®¨è®ºé—®é¢˜

1. ~~**çº åå†å²**æ˜¯å¦éœ€è¦å•ç‹¬æ–‡ä»¶ï¼Œè¿˜æ˜¯è®°å½•åœ¨ä»»åŠ¡é…ç½®ä¸­ï¼Ÿ~~ â†’ å·²ç¡®å®šï¼šå•ç‹¬ `corrections.md` æ–‡ä»¶
2. ~~**æ‰§è¡Œæ—¥å¿—**çš„æ ¼å¼å’Œä¿ç•™ç­–ç•¥ï¼Ÿ~~ â†’ å·²ç¡®å®šï¼š`archon.log`ï¼Œæ¯æ¡å¸¦æ—¶é—´æˆ³
3. ~~**å…¨å±€é…ç½® `setting.json`** éœ€è¦åŒ…å«å“ªäº›å†…å®¹ï¼Ÿ~~ â†’ å·²ç¡®å®šï¼šè§å†³ç­– #2
4. ~~æ˜¯å¦éœ€è¦ **é”æ–‡ä»¶** é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Ÿ~~ â†’ å·²ç¡®å®šï¼šä»»åŠ¡çº§é”æ–‡ä»¶ `task.lock`ï¼Œè§å†³ç­– #3
5. ~~**corrections.md** çš„å…·ä½“æ ¼å¼ï¼Ÿ~~ â†’ å·²ç¡®å®šï¼šè§å†³ç­– #4
6. ~~**config.json** çš„å…·ä½“å­—æ®µï¼Ÿ~~ â†’ å·²ç¡®å®šï¼šè§å†³ç­– #5

**æ‰€æœ‰è®¾è®¡é—®é¢˜å·²è§£å†³ï¼Œå¯è¿›å…¥å¼€å‘é˜¶æ®µã€‚**

---

## ä¸‰ã€è®¾è®¡å†³ç­–è®°å½•

### å†³ç­– #1ï¼šå·¥ä½œç›®å½•ç»“æ„
- **é—®é¢˜**ï¼šæ’ä»¶çš„å·¥ä½œç›®å½•å’ŒæŒä¹…åŒ–æ–‡ä»¶å¦‚ä½•ç»„ç»‡ï¼Ÿ
- **ç»“è®º**ï¼š
  - æ ¹ç›®å½•ï¼š`.claude/daemon-archon/`
  - æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ç›®å½•ï¼Œå‘½åæ ¼å¼ï¼š`æ—¶é—´æˆ³_æ¨¡å¼åç¼€`ï¼ˆå¦‚ `20260201_143000_probe`ï¼‰
  - å…¨å±€é…ç½®ï¼š`setting.json`
  - ä»»åŠ¡çŠ¶æ€ï¼š`status` æ–‡ä»¶ï¼ˆçº¯æ–‡æœ¬ï¼šactive/stopped/pausedï¼‰
  - çº åå†å²ï¼š`corrections.md`ï¼ˆMarkdown æ ¼å¼ï¼Œæ–¹ä¾¿äººè¯»ï¼‰
  - å·¥ä½œæ—¥å¿—ï¼š`archon.log`ï¼ˆæ¯æ¡å¸¦æ—¶é—´æˆ³ï¼‰
  - Cron æ¨¡å¼é¢å¤–åŒ…å« `workflow/` å­æ–‡ä»¶å¤¹
- **ç†ç”±**ï¼š
  - æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ç›®å½•ä¾¿äºç®¡ç†å’Œæ¸…ç†
  - æ—¶é—´æˆ³å‘½åä¾¿äºæ’åºå’Œè¯†åˆ«
  - Markdown æ ¼å¼çš„çº åå†å²ä¾¿äºäººå·¥é˜…è¯»
  - çŠ¶æ€æ–‡ä»¶ç‹¬ç«‹ä¾¿äºå¿«é€Ÿåˆ¤æ–­ä»»åŠ¡çŠ¶æ€
- **æ—¥æœŸ**ï¼š2026-02-01

### å†³ç­– #2ï¼šå…¨å±€é…ç½® setting.json

- **é—®é¢˜**ï¼šå…¨å±€é…ç½®æ–‡ä»¶éœ€è¦åŒ…å«å“ªäº›å†…å®¹ï¼Ÿ
- **ç»“è®º**ï¼š

```json
{
  "version": "1.0",
  "notification": {
    "enabled": true,
    "method": "system",
    "webhook_url": null,
    "slack_webhook": null
  },
  "defaults": {
    "probe_check_interval_minutes": 5,
    "cron_check_interval_minutes": 60,
    "max_auto_corrections": 3
  },
  "claude_cli": {
    "path": "claude",
    "default_model": null
  },
  "logging": {
    "level": "INFO",
    "max_log_size_mb": 10,
    "max_log_files": 5
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `version` | string | é…ç½®æ–‡ä»¶ç‰ˆæœ¬å· |
| `notification.enabled` | boolean | æ˜¯å¦å¯ç”¨é€šçŸ¥ |
| `notification.method` | string | é€šçŸ¥æ–¹å¼ï¼š`system` / `slack` / `email` / `webhook` |
| `notification.webhook_url` | string | è‡ªå®šä¹‰ webhook åœ°å€ï¼ˆå¯é€‰ï¼‰ |
| `notification.slack_webhook` | string | Slack webhook åœ°å€ï¼ˆå¯é€‰ï¼‰ |
| `defaults.probe_check_interval_minutes` | number | Probe æ¨¡å¼é»˜è®¤æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ |
| `defaults.cron_check_interval_minutes` | number | Cron æ¨¡å¼é»˜è®¤æ‰§è¡Œé—´éš”ï¼ˆåˆ†é’Ÿï¼‰ |
| `defaults.max_auto_corrections` | number | æœ€å¤§è‡ªåŠ¨çº åæ¬¡æ•° |
| `claude_cli.path` | string | Claude CLI å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ |
| `claude_cli.default_model` | string | é»˜è®¤ä½¿ç”¨çš„æ¨¡å‹ï¼ˆå¯é€‰ï¼‰ |
| `logging.level` | string | æ—¥å¿—çº§åˆ«ï¼š`DEBUG` / `INFO` / `WARN` / `ERROR` |
| `logging.max_log_size_mb` | number | å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆMBï¼‰ |
| `logging.max_log_files` | number | ä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡ |

- **æ—¥æœŸ**ï¼š2026-02-02

### å†³ç­– #3ï¼šä»»åŠ¡çº§é”æ–‡ä»¶

- **é—®é¢˜**ï¼šæ˜¯å¦éœ€è¦é”æ–‡ä»¶é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Ÿé”æ–‡ä»¶åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ
- **ç»“è®º**ï¼š
  - **éœ€è¦é”æ–‡ä»¶**ï¼Œé‡‡ç”¨**ä»»åŠ¡çº§é”**è€Œéæ’ä»¶çº§é”
  - ä½ç½®ï¼š`ä»»åŠ¡ç›®å½•/task.lock`
  - å†…å®¹æ ¼å¼ï¼š`PID:æ—¶é—´æˆ³`ï¼ˆå¦‚ `12345:2026-02-01T14:30:00Z`ï¼‰
  - è¶…æ—¶æœºåˆ¶ï¼šé”æ–‡ä»¶å­˜åœ¨è¶…è¿‡ 30 åˆ†é’Ÿè§†ä¸ºåƒµå°¸é”ï¼Œå¯ä»¥è¦†ç›–
- **ç†ç”±**ï¼š
  - ä¸åŒä»»åŠ¡ä¹‹é—´åº”è¯¥å¯ä»¥å¹¶è¡Œæ£€æŸ¥ï¼Œäº’ä¸é˜»å¡
  - åªéœ€è¦é˜²æ­¢**åŒä¸€ä¸ªä»»åŠ¡**è¢«å¹¶å‘å¤„ç†
  - ä»»åŠ¡çº§é”æ›´ç»†ç²’åº¦ï¼Œæ›´çµæ´»
  - åœºæ™¯æ”¯æŒï¼š
    - ç”¨æˆ·æ‰‹åŠ¨ `/check-task` ä¸å®šæ—¶å™¨åŒæ—¶è§¦å‘
    - å®šæ—¶å™¨è§¦å‘æ—¶ä¸Šä¸€æ¬¡æ£€æŸ¥å°šæœªå®Œæˆ
- **æ—¥æœŸ**ï¼š2026-02-02

### å†³ç­– #4ï¼šçº åå†å² corrections.md æ ¼å¼è§„èŒƒ

- **é—®é¢˜**ï¼šcorrections.md çš„å…·ä½“æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ
- **ç»“è®º**ï¼šé‡‡ç”¨ Markdown è¡¨æ ¼ + è¯¦æƒ…å—çš„æ··åˆæ ¼å¼

```markdown
# çº åå†å²

## æ‘˜è¦

| # | æ—¶é—´ | çº åè€… | åŸå›  | ç»“æœ |
|---|------|--------|------|------|
| 1 | 2026-02-01 14:30 | Archon | æµ‹è¯•å¤±è´¥ | æˆåŠŸ |
| 2 | 2026-02-01 15:00 | ç”¨æˆ· | æ¶æ„é—®é¢˜ | æˆåŠŸ |

---

## è¯¦ç»†è®°å½•

### #1 - 2026-02-01 14:30:00

**çº åè€…**ï¼šArchonï¼ˆè‡ªåŠ¨ï¼‰

**è§¦å‘åŸå› **ï¼š
- æ£€æµ‹åˆ° 3 ä¸ªå•å…ƒæµ‹è¯•å¤±è´¥
- é”™è¯¯ä¿¡æ¯ï¼š`TypeError: undefined is not a function`

**åˆ†æç»“è®º**ï¼š
- é—®é¢˜çº§åˆ«ï¼šä¸­ç­‰
- æ ¹å› ï¼šå‡½æ•°å‚æ•°ç±»å‹ä¸åŒ¹é…

**çº åæŒ‡ä»¤**ï¼š
\`\`\`
è¯·æ£€æŸ¥ src/utils/helper.ts ä¸­çš„ processData å‡½æ•°ï¼Œ
ç¬¬ 42 è¡Œçš„å‚æ•°ç±»å‹åº”è¯¥æ˜¯ string[] è€Œä¸æ˜¯ stringã€‚
\`\`\`

**æ‰§è¡Œç»“æœ**ï¼šæˆåŠŸ
**åç»­çŠ¶æ€**ï¼šæµ‹è¯•å…¨éƒ¨é€šè¿‡

---
```

**æ ¼å¼è¦ç‚¹**ï¼š
1. **æ‘˜è¦è¡¨æ ¼**ï¼šå¿«é€Ÿæµè§ˆæ‰€æœ‰çº åè®°å½•
2. **è¯¦ç»†è®°å½•**ï¼šæ¯æ¬¡çº åçš„å®Œæ•´ä¿¡æ¯
3. **å¿…å¡«å­—æ®µ**ï¼š
   - çº åè€…ï¼ˆArchon/ç”¨æˆ·ï¼‰
   - è§¦å‘åŸå› 
   - åˆ†æç»“è®ºï¼ˆé—®é¢˜çº§åˆ«ã€æ ¹å› ï¼‰
   - çº åæŒ‡ä»¤
   - æ‰§è¡Œç»“æœ
   - åç»­çŠ¶æ€

- **ç†ç”±**ï¼š
  - Markdown æ ¼å¼ä¾¿äºäººå·¥é˜…è¯»å’Œç¼–è¾‘
  - æ‘˜è¦è¡¨æ ¼ä¾¿äºå¿«é€Ÿå®šä½
  - è¯¦ç»†è®°å½•ä¿ç•™å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œä¾¿äºå¤ç›˜
- **æ—¥æœŸ**ï¼š2026-02-02

### å†³ç­– #5ï¼šconfig.json å­—æ®µå®šä¹‰

- **é—®é¢˜**ï¼šProbe æ¨¡å¼å’Œ Cron æ¨¡å¼çš„ config.json å…·ä½“åŒ…å«å“ªäº›å­—æ®µï¼Ÿ
- **ç»“è®º**ï¼š

#### Probe æ¨¡å¼ config.json

```json
{
  "task_id": "20260201_143000_probe",
  "mode": "probe",
  "name": "ä»£ç é‡æ„ä»»åŠ¡",
  "description": "é‡æ„ src/legacy ç›®å½•ï¼Œè¿ç§»åˆ°æ–°æ¶æ„",
  "project_path": "/home/user/project",
  "created_at": "2026-02-01T14:30:00Z",

  "probe": {
    "session_id": "abc123def456",
    "pid": 12345,
    "initial_prompt": "è¯·é‡æ„ src/legacy ç›®å½•..."
  },

  "schedule": {
    "check_interval_minutes": 5,
    "next_check": "2026-02-01T14:35:00Z"
  },

  "correction": {
    "max_auto_corrections": 3,
    "current_count": 1,
    "escalate_after_failures": 2
  },

  "criteria": {
    "success_indicators": ["æµ‹è¯•é€šè¿‡", "æ—  lint é”™è¯¯"],
    "failure_indicators": ["build å¤±è´¥", "ä¸¥é‡é”™è¯¯"],
    "completion_keywords": ["ä»»åŠ¡å®Œæˆ", "é‡æ„å®Œæˆ"]
  }
}
```

**é‡è¦è¯´æ˜**ï¼š
- `probe.session_id` **å¿…é¡»**ä¸å¯åŠ¨çš„ Claude Code CLI çš„ session_id ä¸€è‡´
- åç»­çš„ `--resume`ã€transcript è¯»å–ç­‰æ“ä½œéƒ½ä¾èµ–æ­¤ session_id

#### Cron æ¨¡å¼ config.json

```json
{
  "task_id": "20260201_150000_cron",
  "mode": "cron",
  "name": "æœåŠ¡å™¨æ—¥å¿—æ£€æŸ¥",
  "description": "æ¯å°æ—¶æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼Œå‘ç°é”™è¯¯é€šçŸ¥",
  "project_path": "/home/user/project",
  "created_at": "2026-02-01T15:00:00Z",

  "schedule": {
    "cron_expression": "0 * * * *",
    "check_interval_minutes": 60,
    "next_run": "2026-02-01T16:00:00Z"
  },

  "execution": {
    "timeout_minutes": 10,
    "last_run": "2026-02-01T15:00:00Z",
    "last_result": "success",
    "run_count": 5,
    "consecutive_failures": 0
  },

  "notification": {
    "notify_on_error": true,
    "notify_on_success": false,
    "quiet_hours": null
  }
}
```

- **æ—¥æœŸ**ï¼š2026-02-02

### å†³ç­– #6ï¼šä»»åŠ¡ç›®æ ‡ destination.mdï¼ˆProbe æ¨¡å¼ä¸“å±ï¼‰

- **é—®é¢˜**ï¼šArchon å¦‚ä½•åˆ¤æ–­ Probe æ˜¯å¦çœŸæ­£å®Œæˆäº†ä»»åŠ¡ï¼Ÿ
- **ç»“è®º**ï¼š
  - æ–°å¢ `destination.md` æ–‡ä»¶ï¼Œä»… Probe æ¨¡å¼ä½¿ç”¨
  - å†…å®¹ä¸ºä»»åŠ¡ç›®æ ‡çš„æç¤ºè¯ï¼ŒArchon ç”¨äºéªŒè¯ä»»åŠ¡å®Œæˆæƒ…å†µ
  - ä½ç½®ï¼š`ä»»åŠ¡ç›®å½•/destination.md`

**æ–‡ä»¶æ ¼å¼**ï¼š

```markdown
# ä»»åŠ¡ç›®æ ‡

## æ ¸å¿ƒç›®æ ‡
[æè¿°ä»»åŠ¡çš„æ ¸å¿ƒç›®æ ‡ï¼ŒArchon å°†ä»¥æ­¤ä¸ºä¾æ®åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ]

## éªŒæ”¶æ ‡å‡†
- [ ] æ ‡å‡† 1ï¼šxxx
- [ ] æ ‡å‡† 2ï¼šxxx
- [ ] æ ‡å‡† 3ï¼šxxx

## å®Œæˆæ ‡å¿—
[æè¿°ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥è®¤ä¸ºä»»åŠ¡å·²å®Œæˆ]

## ç‰¹åˆ«è¯´æ˜
[ä»»ä½•éœ€è¦ Archon æ³¨æ„çš„ç‰¹æ®Šæƒ…å†µ]
```

- **ç†ç”±**ï¼š
  - æ˜ç¡®çš„ä»»åŠ¡ç›®æ ‡ä¾¿äº Archon è¿›è¡ŒéªŒè¯
  - éªŒæ”¶æ ‡å‡†å¯é‡åŒ–ï¼Œå‡å°‘ä¸»è§‚åˆ¤æ–­
  - ä¸ config.json ä¸­çš„ `criteria` é…åˆä½¿ç”¨
- **æ—¥æœŸ**ï¼š2026-02-02

### å†³ç­– #7ï¼šCron æ¨¡å¼æ‰§è¡Œæµç¨‹

- **é—®é¢˜**ï¼šCron æ¨¡å¼çš„ä»»åŠ¡æ‰§è¡Œæµç¨‹å¦‚ä½•è®¾è®¡ï¼Ÿ
- **ç»“è®º**ï¼š

#### æ‰§è¡Œæµç¨‹

```
å®šæ—¶å™¨è§¦å‘
    â”‚
    â–¼
cron_executor.py
    â”‚
    â”œâ”€â†’ 1. æ£€æŸ¥ task.lockï¼ˆé˜²å¹¶å‘ï¼‰
    â”‚
    â”œâ”€â†’ 2. è¯»å– task.md + workflow/workflow.md
    â”‚
    â”œâ”€â†’ 3. æ„å»ºæç¤ºè¯
    â”‚
    â”œâ”€â†’ 4. å¯åŠ¨ä¸´æ—¶ Claude Code CLIï¼ˆ-p å•æ¬¡æ‰§è¡Œï¼‰
    â”‚      claude -p "{prompt}" --output-format json
    â”‚
    â”œâ”€â†’ 5. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆå¸¦è¶…æ—¶ï¼‰
    â”‚
    â”œâ”€â†’ 6. è§£ææ‰§è¡Œç»“æœ
    â”‚
    â”œâ”€â†’ 7. è°ƒç”¨ result_analyzer.py åˆ†æç»“æœ
    â”‚
    â””â”€â†’ 8. æ ¹æ®åˆ†æç»“æœå†³å®šæ˜¯å¦é€šçŸ¥
```

#### CLI è°ƒç”¨æ–¹å¼

é‡‡ç”¨ `-p` å•æ¬¡æ‰§è¡Œæ¨¡å¼ï¼š
- ç®€å•ã€æ— çŠ¶æ€ã€æ‰§è¡Œå®Œå³é€€å‡º
- æ— éœ€ç®¡ç† session
- å¦‚éœ€å¤šè½®å¯¹è¯åœºæ™¯ï¼Œåº”ä½¿ç”¨ Probe æ¨¡å¼

- **ç†ç”±**ï¼š
  - Cron æ¨¡å¼å®šä½æ˜¯å®šæ—¶æ‰§è¡Œç®€å•ä»»åŠ¡ï¼Œå•æ¬¡æ‰§è¡Œè¶³å¤Ÿ
  - ä¿æŒç®€å•ï¼Œé™ä½å¤æ‚åº¦
  - ä¸ Probe æ¨¡å¼å½¢æˆæ˜ç¡®åˆ†å·¥
- **æ—¥æœŸ**ï¼š2026-02-03

### å†³ç­– #8ï¼šWorkflow æ ¼å¼è§„èŒƒ

- **é—®é¢˜**ï¼šworkflow/workflow.md çš„å…·ä½“æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿæ¡ä»¶é€»è¾‘å¦‚ä½•å¤„ç†ï¼Ÿ
- **ç»“è®º**ï¼š

#### æ–‡ä»¶æ ¼å¼

```markdown
# Workflow: {ä»»åŠ¡åç§°}

## å…ƒä¿¡æ¯
- ç‰ˆæœ¬: 1.0
- é¢„è®¡è€—æ—¶: 5 åˆ†é’Ÿ
- å¤±è´¥ç­–ç•¥: stop_on_error | continue_on_error

## æ‰§è¡Œæ­¥éª¤

### Step 1: {æ­¥éª¤åç§°}
- åŠ¨ä½œ: {å…·ä½“è¦åšä»€ä¹ˆ}
- æˆåŠŸæ¡ä»¶: {ä»€ä¹ˆæƒ…å†µç®—æˆåŠŸ}
- å¤±è´¥å¤„ç†: {å¤±è´¥æ—¶æ€ä¹ˆåŠ}

### Step 2: {æ­¥éª¤åç§°}
- åŠ¨ä½œ: {å…·ä½“è¦åšä»€ä¹ˆ}
- æˆåŠŸæ¡ä»¶: {ä»€ä¹ˆæƒ…å†µç®—æˆåŠŸ}
- å…³æ³¨æŒ‡æ ‡:
  - {æŒ‡æ ‡} > {é˜ˆå€¼} â†’ {çº§åˆ«}

## ç»“æœæ±‡æ€»è¦æ±‚

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºç»“æœï¼š

\`\`\`json
{
  "status": "success | warning | error",
  "summary": "ä¸€å¥è¯æ€»ç»“",
  "findings": [
    {"level": "info|warning|error", "message": "å…·ä½“å‘ç°"}
  ],
  "metrics": {
    "key": value
  }
}
\`\`\`
```

#### æ¡ä»¶é€»è¾‘å¤„ç†

é‡‡ç”¨**è‡ªç„¶è¯­è¨€æè¿°**ï¼Œäº¤ç»™ Claude åˆ¤æ–­ï¼š
- ä¸è®¾è®¡å¤æ‚çš„ DSL è¯­æ³•
- åœ¨æ­¥éª¤æè¿°ä¸­ç”¨è‡ªç„¶è¯­è¨€è¯´æ˜æ¡ä»¶
- Claude æ ¹æ®ä¸Šä¸‹æ–‡è‡ªè¡Œç†è§£å’Œæ‰§è¡Œ

**ç¤ºä¾‹**ï¼š
```markdown
### Step 3: å†³å®šæ˜¯å¦æ·±åº¦æ‰«æ
- åŠ¨ä½œ: å¦‚æœ Step 2 å‘ç°çš„é”™è¯¯æ•°é‡è¶…è¿‡ 10 ä¸ªï¼Œæ‰§è¡Œæ·±åº¦æ—¥å¿—åˆ†æï¼›å¦åˆ™è·³è¿‡æ­¤æ­¥éª¤
```

- **ç†ç”±**ï¼š
  - Markdown æ ¼å¼äººç±»å¯è¯»ï¼ŒéæŠ€æœ¯äººå‘˜ä¹Ÿèƒ½ç†è§£
  - è‡ªç„¶è¯­è¨€æè¿°æ¡ä»¶é€»è¾‘ï¼Œé¿å…è®¾è®¡å¤æ‚ DSL
  - ç»“æ„åŒ– JSON è¾“å‡ºä¾¿äºç¨‹åºè§£æ
  - å……åˆ†åˆ©ç”¨ Claude çš„ç†è§£èƒ½åŠ›
- **æ—¥æœŸ**ï¼š2026-02-03

### å†³ç­– #9ï¼šCron ç»“æœåˆ†ææœºåˆ¶

- **é—®é¢˜**ï¼šCron æ¨¡å¼æ‰§è¡Œåï¼Œå¦‚ä½•åˆ¤æ–­"å‘ç°é—®é¢˜"ï¼Ÿä½•æ—¶è§¦å‘é€šçŸ¥ï¼Ÿ
- **ç»“è®º**ï¼š

#### æ··åˆåˆ†ææ–¹æ¡ˆ

é‡‡ç”¨**è§„åˆ™åˆç­› + Claude äºŒæ¬¡åˆ†æ**çš„æ··åˆæ–¹æ¡ˆï¼š

```
Claude CLI è¾“å‡º
    â”‚
    â–¼
result_analyzer.py
    â”‚
    â”œâ”€â†’ 1. è§£æ JSON è¾“å‡º
    â”‚      - æå– status å­—æ®µ
    â”‚      - æå– findings åˆ—è¡¨
    â”‚      - æå– metrics æ•°æ®
    â”‚
    â”œâ”€â†’ 2. è§„åˆ™åˆç­›
    â”‚      - status == "error" â†’ ç¡®å®šéœ€è¦é€šçŸ¥
    â”‚      - status == "success" ä¸”æ— å¼‚å¸¸æŒ‡æ ‡ â†’ ç¡®å®šä¸éœ€è¦é€šçŸ¥
    â”‚      - status == "warning" æˆ–æŒ‡æ ‡æ¥è¿‘é˜ˆå€¼ â†’ å¯ç–‘ï¼Œéœ€äºŒæ¬¡åˆ†æ
    â”‚
    â”œâ”€â†’ 3. å¯ç–‘æƒ…å†µäº¤ç»™ Claude äºŒæ¬¡åˆ†æ
    â”‚      - æ„å»ºåˆ†ææç¤ºè¯ï¼ŒåŒ…å«åŸå§‹è¾“å‡ºå’Œä¸Šä¸‹æ–‡
    â”‚      - Claude åˆ¤æ–­æ˜¯å¦çœŸçš„éœ€è¦é€šçŸ¥
    â”‚      - è¿”å›åˆ†æç»“è®º
    â”‚
    â””â”€â†’ 4. ç”Ÿæˆæœ€ç»ˆç»“è®ºå¹¶è®°å½•
```

#### é€šçŸ¥è§„åˆ™é…ç½®

åœ¨ `config.json` ä¸­å®šä¹‰ï¼š

```json
{
  "notification_rules": {
    "notify_on_status": ["error"],
    "suspicious_status": ["warning"],
    "metric_thresholds": {
      "error_count": { "warn": 10, "error": 50 },
      "disk_usage_percent": { "warn": 80, "error": 95 }
    },
    "enable_claude_analysis": true
  }
}
```

#### åˆ†æç»“æœåˆ†ç±»

| åˆç­›ç»“æœ | å¤„ç†æ–¹å¼ |
|----------|----------|
| ç¡®å®šå¼‚å¸¸ | ç›´æ¥é€šçŸ¥ |
| ç¡®å®šæ­£å¸¸ | ä¸é€šçŸ¥ï¼Œä»…è®°å½•æ—¥å¿— |
| å¯ç–‘æƒ…å†µ | äº¤ç»™ Claude äºŒæ¬¡åˆ†æåå†³å®š |

- **ç†ç”±**ï¼š
  - è§„åˆ™åˆç­›å¿«é€Ÿã€ä½æˆæœ¬ï¼Œå¤„ç†æ˜ç¡®æƒ…å†µ
  - Claude äºŒæ¬¡åˆ†æå¤„ç†è¾¹ç•Œæƒ…å†µï¼Œå‡å°‘æ¼æŠ¥/è¯¯æŠ¥
  - å¯é…ç½®æ˜¯å¦å¯ç”¨ Claude åˆ†æï¼Œå¹³è¡¡æˆæœ¬å’Œæ™ºèƒ½
- **æ—¥æœŸ**ï¼š2026-02-03

### å†³ç­– #10ï¼šæ¶æ„å˜æ›´ - FastAPI äº‹ä»¶å¾ªç¯

- **é—®é¢˜**ï¼šå®šæ—¶è°ƒåº¦é‡‡ç”¨ç³»ç»Ÿ cron è¿˜æ˜¯ä»£ç å®ç°ï¼Ÿ
- **ç»“è®º**ï¼š

#### å˜æ›´åŸå› 

ä¸ä¾èµ–ç³»ç»Ÿ crontab/Task Schedulerï¼Œæ”¹ç”¨ FastAPI + APScheduler ä»£ç å®ç°å®šæ—¶è°ƒåº¦ã€‚

#### æ¶æ„æ–¹æ¡ˆï¼šæ’ä»¶å†…åµŒ FastAPI æœåŠ¡

```
daemon-archon/ï¼ˆæ’ä»¶ç›®å½•ï¼‰
â”œâ”€â”€ commands/
â”‚   â”œâ”€â”€ archon-start.md      # å¯åŠ¨æœåŠ¡
â”‚   â”œâ”€â”€ archon-stop.md       # åœæ­¢æœåŠ¡
â”‚   â”œâ”€â”€ archon-status.md     # æŸ¥çœ‹çŠ¶æ€
â”‚   â”œâ”€â”€ archon-create.md     # åˆ›å»ºä»»åŠ¡
â”‚   â””â”€â”€ archon-list.md       # åˆ—å‡ºä»»åŠ¡
â”‚
â”œâ”€â”€ hooks/                   # å¯é€‰
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ server/              # FastAPI æœåŠ¡ä»£ç 
â”‚       â”œâ”€â”€ main.py          # FastAPI å…¥å£
â”‚       â”œâ”€â”€ scheduler.py     # APScheduler è°ƒåº¦
â”‚       â”œâ”€â”€ executor.py      # ä»»åŠ¡æ‰§è¡Œï¼ˆsubprocess è°ƒç”¨ claudeï¼‰
â”‚       â”œâ”€â”€ analyzer.py      # ç»“æœåˆ†æ
â”‚       â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ settings.json
â””â”€â”€ README.md
```

#### æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·æ‰§è¡Œ /archon-start
    â”‚
    â–¼
Claude Code å¯åŠ¨ scripts/server/main.py
    â”‚
    â–¼
FastAPI æœåŠ¡è¿è¡Œï¼ˆç”¨æˆ·æƒé™ï¼‰
    â”‚
    â”œâ”€â†’ APScheduler å®šæ—¶è§¦å‘
    â”‚
    â””â”€â†’ subprocess.run(['claude', '-p', prompt])
            â”‚
            â””â”€â†’ Claude CLI ä»¥ç”¨æˆ·æƒé™æ‰§è¡Œï¼ˆå®Œæ•´æƒé™ï¼‰
```

#### æƒé™åˆ†æ

æœåŠ¡é€šè¿‡ subprocess è°ƒç”¨ Claude CLIï¼Œæƒé™é“¾å®Œæ•´ï¼š
- æœåŠ¡ä»¥ç”¨æˆ·æƒé™è¿è¡Œ
- Claude CLI æ‹¥æœ‰å®Œæ•´æƒé™ï¼ˆè¯»å†™æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ï¼‰
- ä¸ç³»ç»Ÿ cron æ–¹æ¡ˆæƒé™ç›¸åŒï¼Œä¸ä¼šå—é™

- **ç†ç”±**ï¼š
  - è·¨å¹³å°ä¸€è‡´ï¼Œä¸ä¾èµ–ç³»ç»Ÿå®šæ—¶å™¨
  - ä»£ç å®ç°ï¼Œæ˜“äºè°ƒè¯•å’Œæµ‹è¯•
  - æ’ä»¶å†…åµŒï¼Œå®‰è£…éƒ¨ç½²ç®€å•
  - æœåŠ¡ä¸ä¼šç‰¹åˆ«å¤æ‚ï¼Œå†…åµŒåˆé€‚
- **æ—¥æœŸ**ï¼š2026-02-03

### å†³ç­– #11ï¼šä»»åŠ¡æŒä¹…åŒ–æ–¹æ¡ˆ

- **é—®é¢˜**ï¼šAPScheduler æ˜¯å¦éœ€è¦ SQLite æŒä¹…åŒ–ï¼Ÿ
- **ç»“è®º**ï¼š

#### é‡‡ç”¨æ–‡ä»¶æŒä¹…åŒ–

ä¸ä½¿ç”¨ SQLiteï¼Œä»»åŠ¡é…ç½®å­˜å‚¨åœ¨ JSON æ–‡ä»¶ä¸­ï¼š
- æ¯ä¸ªä»»åŠ¡ä¸€ä¸ªç›®å½•ï¼ŒåŒ…å« `config.json`
- æœåŠ¡å¯åŠ¨æ—¶æ‰«æ `~/.claude/daemon-archon/` æ¢å¤æ‰€æœ‰ `active` ä»»åŠ¡
- APScheduler ä½¿ç”¨å†…å­˜ JobStore

#### æœåŠ¡å¯åŠ¨æ¢å¤é€»è¾‘

```python
async def startup_event():
    """æœåŠ¡å¯åŠ¨æ—¶æ¢å¤æ‰€æœ‰æ´»è·ƒä»»åŠ¡"""
    scheduler = ArchonScheduler()

    # æ‰«ææ‰€æœ‰ä»»åŠ¡ç›®å½•
    for task_dir in scan_task_directories():
        config = load_config(task_dir)

        if config["state"]["status"] == "active":
            scheduler.add_task(
                task_id=config["task_id"],
                interval_minutes=config["schedule"]["check_interval_minutes"],
                mode=config["mode"]
            )

    scheduler.start()
```

- **ç†ç”±**ï¼š
  - ç®€å•ã€æ˜“è°ƒè¯•ã€ç”¨æˆ·å¯ç›´æ¥æŸ¥çœ‹/ç¼–è¾‘é…ç½®æ–‡ä»¶
  - å¯¹äºä»»åŠ¡é‡ä¸å¤§çš„åœºæ™¯ï¼Œæ–‡ä»¶æŒä¹…åŒ–è¶³å¤Ÿ
  - é¿å…å¼•å…¥ SQLite å¢åŠ å¤æ‚åº¦
- **æ—¥æœŸ**ï¼š2026-02-03

### å†³ç­– #12ï¼šç¯å¢ƒæ£€æŸ¥å‘½ä»¤

- **é—®é¢˜**ï¼šå¦‚ä½•å¸®åŠ©ç”¨æˆ·æ£€æŸ¥ç¯å¢ƒæ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Ÿ
- **ç»“è®º**ï¼š

#### æ–°å¢ /archon-init å‘½ä»¤

æ£€æŸ¥ç¯å¢ƒå¹¶è¾“å‡ºå¯¹ç…§è¡¨ï¼š

```
æ£€æŸ¥é¡¹                          çŠ¶æ€   è¯¦æƒ…
------------------------------------------------------------
Claude CLI                     âœ“     claude 2.1.0
Python ç‰ˆæœ¬                    âœ“     Python 3.10
Python åŒ…: fastapi             âœ“     å·²å®‰è£…
Python åŒ…: uvicorn             âœ“     å·²å®‰è£…
Python åŒ…: apscheduler         âœ“     å·²å®‰è£…
Python åŒ…: anthropic           âœ—     æœªå®‰è£…
å·¥ä½œç›®å½•æƒé™                    âœ“     /home/user/.claude/daemon-archon
```

#### æ£€æŸ¥é¡¹

1. Claude CLI æ˜¯å¦å®‰è£…åŠç‰ˆæœ¬
2. Python ç‰ˆæœ¬ï¼ˆ>= 3.8ï¼‰
3. å¿…è¦çš„ Python åŒ…ï¼ˆfastapiã€uvicornã€apschedulerã€anthropicï¼‰
4. å·¥ä½œç›®å½•æƒé™ï¼ˆ~/.claude/daemon-archonï¼‰

#### ä¿®å¤å»ºè®®

å¯¹äºæœªé€šè¿‡çš„æ£€æŸ¥é¡¹ï¼Œè¾“å‡ºå…·ä½“çš„å®‰è£…/ä¿®å¤æŒ‡ä»¤ã€‚

- **ç†ç”±**ï¼š
  - é™ä½ç”¨æˆ·ä½¿ç”¨é—¨æ§›ï¼Œå¿«é€Ÿå‘ç°ç¯å¢ƒé—®é¢˜
  - æä¾›æ˜ç¡®çš„ä¿®å¤æŒ‡å¯¼
  - é¿å…æœåŠ¡å¯åŠ¨åæ‰å‘ç°ç¯å¢ƒé—®é¢˜
- **æ—¥æœŸ**ï¼š2026-02-03

### å†³ç­– #13ï¼šæ‰§è¡Œè¶…æ—¶æœºåˆ¶

- **é—®é¢˜**ï¼šProbe å’Œ Cron æ¨¡å¼æ˜¯å¦éœ€è¦è¶…æ—¶æœºåˆ¶ï¼Ÿ
- **ç»“è®º**ï¼š

#### Probe æ¨¡å¼ï¼šä¸è®¾ç½®è¶…æ—¶

- Probe ä»»åŠ¡å¯èƒ½æ‰§è¡Œå¾ˆä¹…ï¼ˆå¦‚ä»£ç é‡æ„ï¼‰
- ç”± Archon å®šæ—¶ç›‘æµ‹çŠ¶æ€ï¼Œæ— éœ€è¶…æ—¶ç»ˆæ­¢
- ç”¨æˆ·å¯æ‰‹åŠ¨åœæ­¢ï¼š`/stop-probe <task_id>`

#### Cron æ¨¡å¼ï¼š10 åˆ†é’Ÿè¶…æ—¶

```python
def execute_cron(task_id: str):
    """æ‰§è¡Œ Cron ä»»åŠ¡"""
    config = load_config(task_id)
    timeout_seconds = config["execution"].get("timeout_minutes", 10) * 60

    try:
        result = subprocess.run(
            ['claude', '-p', prompt, '--output-format', 'json'],
            cwd=config["project_path"],
            capture_output=True,
            text=True,
            timeout=timeout_seconds
        )
        return analyze_result(result.stdout)

    except subprocess.TimeoutExpired:
        handle_timeout(task_id, config)
```

#### è¶…æ—¶å¤„ç†ç­–ç•¥

```python
def handle_timeout(task_id: str, config: dict):
    """å¤„ç†è¶…æ—¶"""
    # 1. è®°å½•æ—¥å¿—
    log_timeout(task_id)

    # 2. æ›´æ–°é…ç½®
    config["execution"]["last_result"] = "timeout"
    config["execution"]["consecutive_failures"] += 1
    save_config(task_id, config)

    # 3. æ£€æŸ¥è¿ç»­å¤±è´¥æ¬¡æ•°
    max_failures = config["execution"].get("max_consecutive_failures", 3)

    if config["execution"]["consecutive_failures"] >= max_failures:
        # è¾¾åˆ°é˜ˆå€¼ï¼Œæš‚åœä»»åŠ¡
        config["state"]["status"] = "paused"
        save_config(task_id, config)
        scheduler.remove_task(task_id)

        # å‘é€é€šçŸ¥
        notifier.send(
            title="ä»»åŠ¡è¶…æ—¶æš‚åœ",
            message=f"ä»»åŠ¡ {task_id} è¿ç»­è¶…æ—¶ {max_failures} æ¬¡ï¼Œå·²è‡ªåŠ¨æš‚åœ"
        )
    else:
        # æœªè¾¾åˆ°é˜ˆå€¼ï¼Œä»…é€šçŸ¥
        notifier.send(
            title="ä»»åŠ¡æ‰§è¡Œè¶…æ—¶",
            message=f"ä»»åŠ¡ {task_id} æ‰§è¡Œè¶…æ—¶"
        )
```

#### é…ç½®å‚æ•°

```json
{
  "execution": {
    "timeout_minutes": 10,
    "max_consecutive_failures": 3
  }
}
```

- **ç†ç”±**ï¼š
  - Probe æ¨¡å¼ä»»åŠ¡å¯èƒ½å¾ˆé•¿ï¼Œä¸åº”è¶…æ—¶ç»ˆæ­¢
  - Cron æ¨¡å¼å®šä½æ˜¯å¿«é€Ÿå·¡æ£€ï¼Œ10 åˆ†é’Ÿè¶…æ—¶åˆç†
  - è¿ç»­å¤±è´¥è‡ªåŠ¨æš‚åœï¼Œé¿å…æŒç»­æ¶ˆè€—èµ„æº
- **æ—¥æœŸ**ï¼š2026-02-03

### å†³ç­– #14ï¼šé£ä¹¦é€šçŸ¥æœºåˆ¶ï¼ˆå¯é€‰æ‰©å±•ï¼‰

- **é—®é¢˜**ï¼šå¦‚ä½•å®ç°é£ä¹¦åŒå‘é€šçŸ¥ï¼Œè®©ç”¨æˆ·å¯ä»¥åœ¨é£ä¹¦ä¸­æ¥æ”¶é€šçŸ¥å¹¶æ§åˆ¶ä»»åŠ¡ï¼ŸåŒæ—¶ä¿æŒæ ¸å¿ƒåŠŸèƒ½çš„ç‹¬ç«‹æ€§ï¼Ÿ
- **ç»“è®º**ï¼š

#### æ ¸å¿ƒè®¾è®¡åŸåˆ™

**é£ä¹¦é€šçŸ¥æ˜¯å¯é€‰çš„æ‰©å±•åŠŸèƒ½**ï¼Œæ ¸å¿ƒåŠŸèƒ½ä¸ä¾èµ–é€šçŸ¥ç³»ç»Ÿï¼š
- âœ… å³ä½¿ä¸é…ç½®é€šçŸ¥ï¼Œæ’ä»¶ä»å¯æ­£å¸¸å·¥ä½œ
- âœ… é€šçŸ¥å‘é€å¤±è´¥ä¸å½±å“ä»»åŠ¡æ‰§è¡Œ
- âœ… é€šè¿‡ `/add-feishu-channel` å‘½ä»¤å¼•å¯¼å®‰è£…å’Œé…ç½®

#### æ¶æ„æ–¹æ¡ˆ

é‡‡ç”¨**é£ä¹¦ä¼ä¸šåº”ç”¨ + FastAPI å›è°ƒæ¥å£**çš„æ–¹æ¡ˆï¼Œå®ç°åŒå‘äº¤äº’ã€‚

```
daemon-archon (FastAPI)
    â”‚
    â”œâ”€â†’ å•å‘é€šçŸ¥ï¼šè°ƒç”¨é£ä¹¦ API å‘é€æ¶ˆæ¯
    â”‚   â””â”€â†’ POST /open-apis/im/v1/messages
    â”‚
    â””â”€â†’ åŒå‘äº¤äº’ï¼šæ¥æ”¶é£ä¹¦äº‹ä»¶å›è°ƒ
        â””â”€â†’ POST /feishu/callback (FastAPI æ¥å£)
```

#### è®¤è¯æ–¹å¼

- **App ID + App Secret**ï¼šé£ä¹¦ä¼ä¸šåº”ç”¨å‡­è¯
- **tenant_access_token**ï¼šé€šè¿‡ App ID/Secret è·å–ï¼Œç”¨äºè°ƒç”¨é£ä¹¦ API
- **äº‹ä»¶ç­¾åéªŒè¯**ï¼šéªŒè¯é£ä¹¦å›è°ƒè¯·æ±‚çš„ç­¾åï¼Œé˜²æ­¢ä¼ªé€ 

#### æ¶ˆæ¯æ ¼å¼

é‡‡ç”¨**é£ä¹¦äº¤äº’å¼å¡ç‰‡**ï¼ˆInteractive Cardï¼‰ï¼š

```json
{
  "msg_type": "interactive",
  "card": {
    "header": {
      "title": { "tag": "plain_text", "content": "ğŸš¨ ä»»åŠ¡é”™è¯¯: probe-001" },
      "template": "red"
    },
    "elements": [
      {
        "tag": "div",
        "text": {
          "tag": "lark_md",
          "content": "**ä»»åŠ¡åç§°**: ä»£ç é‡æ„ä»»åŠ¡\n**é”™è¯¯ä¿¡æ¯**: æµ‹è¯•å¤±è´¥"
        }
      },
      {
        "tag": "action",
        "actions": [
          {
            "tag": "button",
            "text": { "tag": "plain_text", "content": "æš‚åœä»»åŠ¡" },
            "type": "default",
            "value": { "action": "pause_task", "task_id": "probe-001" }
          },
          {
            "tag": "button",
            "text": { "tag": "plain_text", "content": "åœæ­¢ä»»åŠ¡" },
            "type": "danger",
            "value": { "action": "stop_task", "task_id": "probe-001" }
          }
        ]
      }
    ]
  }
}
```

**å¡ç‰‡ç‰¹ç‚¹**ï¼š
- æ”¯æŒ Markdown æ ¼å¼æ–‡æœ¬
- æ”¯æŒæŒ‰é’®äº¤äº’ï¼ˆæŸ¥çœ‹æ—¥å¿—ã€æš‚åœã€åœæ­¢ç­‰ï¼‰
- æ”¯æŒé¢œè‰²æ¨¡æ¿ï¼ˆinfo: blue, warning: orange, error: redï¼‰
- æ”¯æŒæ—¶é—´æˆ³å’Œæ¥æºæ ‡æ³¨

#### äº¤äº’å‘½ä»¤

ç”¨æˆ·å¯ä»¥åœ¨é£ä¹¦ä¸­å‘é€å‘½ä»¤æˆ–ç‚¹å‡»å¡ç‰‡æŒ‰é’®ï¼š

| äº¤äº’æ–¹å¼ | å‘½ä»¤/æ“ä½œ | è¯´æ˜ |
|---------|----------|------|
| æ–‡æœ¬å‘½ä»¤ | `/pause <task_id>` | æš‚åœä»»åŠ¡ |
| æ–‡æœ¬å‘½ä»¤ | `/resume <task_id>` | æ¢å¤ä»»åŠ¡ |
| æ–‡æœ¬å‘½ä»¤ | `/stop <task_id>` | åœæ­¢ä»»åŠ¡ |
| æ–‡æœ¬å‘½ä»¤ | `/status [task_id]` | æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ |
| æ–‡æœ¬å‘½ä»¤ | `/logs <task_id>` | æŸ¥çœ‹ä»»åŠ¡æ—¥å¿— |
| æ–‡æœ¬å‘½ä»¤ | `/list` | åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡ |
| å¡ç‰‡æŒ‰é’® | ç‚¹å‡»"æš‚åœä»»åŠ¡" | æš‚åœæŒ‡å®šä»»åŠ¡ |
| å¡ç‰‡æŒ‰é’® | ç‚¹å‡»"åœæ­¢ä»»åŠ¡" | åœæ­¢æŒ‡å®šä»»åŠ¡ |
| å¡ç‰‡æŒ‰é’® | ç‚¹å‡»"æŸ¥çœ‹æ—¥å¿—" | è¿”å›ä»»åŠ¡æ—¥å¿—æ‘˜è¦ |

#### é…ç½®ç»“æ„

åœ¨ `setting.json` ä¸­æ–°å¢ `feishu` é…ç½®ï¼š

```json
{
  "version": "1.0",
  "notification": {
    "enabled": true,
    "method": "feishu",
    "webhook_url": null,
    "slack_webhook": null,
    "feishu": {
      "enabled": true,
      "app_id": "cli_xxx",
      "app_secret": "xxx",
      "domain": "feishu",
      "receive_id_type": "open_id",
      "target_user_id": "ou_xxx",
      "enable_commands": true,
      "allowed_users": ["ou_xxx", "ou_yyy"],
      "card_style": "interactive"
    }
  }
}
```

**é…ç½®å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `app_id` | string | é£ä¹¦åº”ç”¨ IDï¼ˆcli_xxxï¼‰ |
| `app_secret` | string | é£ä¹¦åº”ç”¨å¯†é’¥ |
| `domain` | string | `feishu`ï¼ˆä¸­å›½ï¼‰æˆ– `lark`ï¼ˆå›½é™…ï¼‰ |
| `receive_id_type` | string | æ¥æ”¶è€… ID ç±»å‹ï¼š`open_id` / `union_id` / `chat_id` |
| `target_user_id` | string | æ¥æ”¶é€šçŸ¥çš„ç”¨æˆ· ID |
| `enable_commands` | boolean | æ˜¯å¦å¯ç”¨å‘½ä»¤äº¤äº’ |
| `allowed_users` | array | å…è®¸æ‰§è¡Œå‘½ä»¤çš„ç”¨æˆ·ç™½åå• |
| `card_style` | string | å¡ç‰‡æ ·å¼ï¼š`simple` / `interactive` |

#### å®ç°æ–‡ä»¶

æ–°å¢ä»¥ä¸‹æ–‡ä»¶ï¼š

```
scripts/server/
â”œâ”€â”€ feishu_client.py         # é£ä¹¦ API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ get_tenant_access_token()  # è·å–è®¿é—®ä»¤ç‰Œ
â”‚   â”œâ”€â”€ send_message()             # å‘é€æ¶ˆæ¯
â”‚   â””â”€â”€ send_card()                # å‘é€å¡ç‰‡
â”‚
â”œâ”€â”€ feishu_card_builder.py   # å¡ç‰‡æ„å»ºå™¨
â”‚   â”œâ”€â”€ build_error_card()         # æ„å»ºé”™è¯¯é€šçŸ¥å¡ç‰‡
â”‚   â”œâ”€â”€ build_completed_card()     # æ„å»ºå®Œæˆé€šçŸ¥å¡ç‰‡
â”‚   â”œâ”€â”€ build_stuck_card()         # æ„å»ºå¡ä½é€šçŸ¥å¡ç‰‡
â”‚   â””â”€â”€ build_status_card()        # æ„å»ºçŠ¶æ€æŸ¥è¯¢å¡ç‰‡
â”‚
â”œâ”€â”€ feishu_handler.py        # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”œâ”€â”€ handle_message_event()     # å¤„ç†æ¶ˆæ¯äº‹ä»¶
â”‚   â”œâ”€â”€ handle_card_action()       # å¤„ç†å¡ç‰‡äº¤äº’
â”‚   â”œâ”€â”€ parse_command()            # è§£æå‘½ä»¤
â”‚   â””â”€â”€ verify_user_permission()   # éªŒè¯ç”¨æˆ·æƒé™
â”‚
â””â”€â”€ notifier.py (æ‰©å±•)
    â””â”€â”€ _send_feishu_notification()  # æ–°å¢é£ä¹¦é€šçŸ¥æ–¹æ³•
```

æ‰©å±• `main.py`ï¼ˆFastAPIï¼‰ï¼š

```python
@app.post("/feishu/callback")
async def feishu_callback(request: Request):
    """é£ä¹¦äº‹ä»¶å›è°ƒæ¥å£"""
    # 1. éªŒè¯ç­¾å
    event_data = await verify_feishu_signature(request, app_secret)

    # 2. å¤„ç†äº‹ä»¶
    if event_data["type"] == "url_verification":
        # é¦–æ¬¡é…ç½®éªŒè¯
        return {"challenge": event_data["challenge"]}

    elif event_data["type"] == "event_callback":
        # æ¶ˆæ¯äº‹ä»¶
        event = event_data["event"]
        if event["type"] == "message":
            await feishu_handler.handle_message_event(event)

    return {"code": 0}

@app.post("/feishu/card-action")
async def feishu_card_action(request: Request):
    """é£ä¹¦å¡ç‰‡äº¤äº’å›è°ƒæ¥å£"""
    # 1. éªŒè¯ç­¾å
    action_data = await verify_feishu_signature(request, app_secret)

    # 2. å¤„ç†å¡ç‰‡äº¤äº’
    await feishu_handler.handle_card_action(action_data)

    return {"code": 0}
```

#### `/add-feishu-channel` å‘½ä»¤

**åŠŸèƒ½**ï¼šå¼•å¯¼ç”¨æˆ·å®‰è£…å’Œé…ç½®é£ä¹¦é€šçŸ¥æ‰©å±•

**æ‰§è¡Œæµç¨‹**ï¼š
```
/add-feishu-channel
    â”‚
    â”œâ”€â†’ 1. æ£€æŸ¥ä¾èµ–ï¼ˆrequests åº“ï¼‰
    â”‚      â””â”€â†’ å¦‚æœæœªå®‰è£…ï¼Œæç¤ºï¼špip install requests
    â”‚
    â”œâ”€â†’ 2. å¼•å¯¼åˆ›å»ºé£ä¹¦åº”ç”¨
    â”‚      â””â”€â†’ æ˜¾ç¤ºåˆ›å»ºæ­¥éª¤å’Œæƒé™é…ç½®
    â”‚
    â”œâ”€â†’ 3. æ”¶é›†é…ç½®ä¿¡æ¯
    â”‚      â”œâ”€â†’ App ID (cli_xxx)
    â”‚      â”œâ”€â†’ App Secret
    â”‚      â”œâ”€â†’ åŸŸå (feishu/lark)
    â”‚      â”œâ”€â†’ ç›®æ ‡ç”¨æˆ· ID (ou_xxx)
    â”‚      â””â”€â†’ æ˜¯å¦å¯ç”¨å‘½ä»¤äº¤äº’
    â”‚
    â”œâ”€â†’ 4. æµ‹è¯•è¿æ¥
    â”‚      â”œâ”€â†’ è·å– tenant_access_token
    â”‚      â”œâ”€â†’ å‘é€æµ‹è¯•æ¶ˆæ¯
    â”‚      â””â”€â†’ éªŒè¯æ¶ˆæ¯å‘é€æˆåŠŸ
    â”‚
    â””â”€â†’ 5. ä¿å­˜é…ç½®
           â”œâ”€â†’ æ›´æ–° setting.json
           â”œâ”€â†’ è®¾ç½® notification.method = "feishu"
           â””â”€â†’ æ˜¾ç¤ºé…ç½®æˆåŠŸä¿¡æ¯
```

**å®ç°æ–‡ä»¶**ï¼š`scripts/add_feishu_channel.py`

#### å®ç°åˆ†é˜¶æ®µ

**Phase 1ï¼šå•å‘é€šçŸ¥ï¼ˆç³»ç»Ÿ â†’ é£ä¹¦ï¼‰**

- å®ç° `feishu_client.py`ï¼šé£ä¹¦ API å®¢æˆ·ç«¯
- å®ç° `feishu_card_builder.py`ï¼šå¡ç‰‡æ„å»ºå™¨
- æ‰©å±• `notifier.py`ï¼šæ–°å¢ `_send_feishu_notification()` æ–¹æ³•
- å®ç° `/add-feishu-channel` å‘½ä»¤å’Œå¼•å¯¼è„šæœ¬
- æ”¯æŒå‘é€äº¤äº’å¼å¡ç‰‡æ¶ˆæ¯
- **é¢„è®¡å·¥ä½œé‡**ï¼š2-3å¤©

**Phase 2ï¼šåŒå‘äº¤äº’ï¼ˆé£ä¹¦ â†’ ç³»ç»Ÿï¼‰**

- å®ç° `feishu_handler.py`ï¼šæ¶ˆæ¯å¤„ç†å™¨
- æ‰©å±• `main.py`ï¼šæ–°å¢é£ä¹¦å›è°ƒæ¥å£
- æ”¯æŒå‘½ä»¤è§£æå’Œæ‰§è¡Œ
- æ”¯æŒå¡ç‰‡æŒ‰é’®äº¤äº’
- æƒé™éªŒè¯ï¼ˆç™½åå•ï¼‰
- **é¢„è®¡å·¥ä½œé‡**ï¼š3-4å¤©

**Phase 3ï¼šé«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰**

- é£ä¹¦ WebSocket é•¿è¿æ¥ï¼ˆæ›¿ä»£ HTTP å›è°ƒï¼‰
- ç¾¤èŠæ”¯æŒï¼ˆ@æœºå™¨äººè§¦å‘ï¼‰
- å¯Œæ–‡æœ¬æ¶ˆæ¯ï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ï¼‰
- æ¶ˆæ¯å†å²è®°å½•
- **é¢„è®¡å·¥ä½œé‡**ï¼š5-7å¤©

#### å®‰å…¨æœºåˆ¶

1. **ç­¾åéªŒè¯**ï¼š
   ```python
   import hmac
   import hashlib

   def verify_signature(timestamp, nonce, body, signature, app_secret):
       sign_str = f"{timestamp}{nonce}{app_secret}{body}"
       calculated = hmac.new(
           app_secret.encode("utf-8"),
           sign_str.encode("utf-8"),
           hashlib.sha256
       ).hexdigest()
       return calculated == signature
   ```

2. **ç™½åå•æœºåˆ¶**ï¼š
   - åªå…è®¸ `allowed_users` ä¸­çš„ç”¨æˆ·æ‰§è¡Œå‘½ä»¤
   - éªŒè¯ç”¨æˆ·çš„ `open_id` æˆ– `union_id`

3. **æƒé™åˆ†çº§**ï¼ˆæœªæ¥æ‰©å±•ï¼‰ï¼š
   - æŸ¥çœ‹æƒé™ï¼š`/status`, `/list`, `/logs`
   - æ§åˆ¶æƒé™ï¼š`/pause`, `/resume`
   - å±é™©æƒé™ï¼š`/stop`, `/delete`

4. **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**ï¼š
   - `app_secret` ä¸è®°å½•åˆ°æ—¥å¿—
   - æ—¥å¿—ä¸­è„±æ•ç”¨æˆ· IDï¼ˆæ˜¾ç¤ºå‰ 6 ä½ï¼‰

#### å‚è€ƒå®ç°

å€Ÿé‰´ OpenClaw é£ä¹¦æ’ä»¶çš„ä¼˜ç§€è®¾è®¡ï¼š
- WebSocket é•¿è¿æ¥æœºåˆ¶
- é…ç½®ç»“æ„ï¼ˆdmPolicy, groupPolicy, allowFromï¼‰
- æ¶ˆæ¯æ ¼å¼åŒ–å’Œ Markdown æ”¯æŒ
- äº‹ä»¶å¤„ç†å’Œè·¯ç”±æœºåˆ¶

- **ç†ç”±**ï¼š
  - **æ ¸å¿ƒåŠŸèƒ½ç‹¬ç«‹**ï¼šä¸ä¾èµ–é€šçŸ¥ç³»ç»Ÿï¼Œä¿æŒæ’ä»¶çš„ç®€æ´æ€§
  - **å¯é€‰æ‰©å±•**ï¼šé€šè¿‡å‘½ä»¤å¼•å¯¼å®‰è£…ï¼Œé™ä½ä½¿ç”¨é—¨æ§›
  - **é£ä¹¦ä¼ä¸šåº”ç”¨**ï¼šæ”¯æŒåŒå‘äº¤äº’ï¼ŒåŠŸèƒ½å¼ºå¤§
  - **äº¤äº’å¼å¡ç‰‡**ï¼šæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
  - **å‘½ä»¤å’ŒæŒ‰é’®**ï¼šä¸¤ç§äº¤äº’æ–¹å¼ï¼Œçµæ´»ä¾¿æ·
  - **ç™½åå•æœºåˆ¶**ï¼šä¿è¯å®‰å…¨æ€§
  - **å€Ÿé‰´ OpenClaw**ï¼šå‚è€ƒæˆç†Ÿå®ç°ï¼Œé™ä½å¼€å‘é£é™©
- **æ—¥æœŸ**ï¼š2026-02-05

