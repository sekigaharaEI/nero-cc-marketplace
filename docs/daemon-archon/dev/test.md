# daemon-archon 测试记录

## 测试环境

- **日期**: 2026-02-04 ~ 2026-02-05
- **系统**: Linux 6.5.0-35-generic
- **Python**: 3.12.2
- **Claude CLI**: 2.1.31

---

## 已完成测试

### 1. 环境初始化测试 (`/archon-init`)

| 测试项 | 状态 | 说明 |
|--------|------|------|
| Claude CLI 检测 | ✓ 通过 | 版本 2.1.31 |
| Python 版本检测 | ✓ 通过 | Python 3.12.2 |
| fastapi 依赖 | ✓ 通过 | 0.116.1 |
| uvicorn 依赖 | ✓ 通过 | 0.35.0 |
| apscheduler 依赖 | ✓ 通过 | 3.11.2 (手动安装) |
| psutil 依赖 | ✓ 通过 | 7.2.2 (手动安装) |
| 工作目录权限 | ✓ 通过 | ~/.claude/daemon-archon |

**发现问题**: 无

---

### 2. 服务启动测试 (`/archon-start`)

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 首次启动 | ✗ 失败 | BUG-001: 相对导入错误 |
| 修复后启动 | ✓ 通过 | PID: 808921 |
| API 可访问 | ✓ 通过 | http://127.0.0.1:8765 |
| 调度器启动 | ✓ 通过 | APScheduler 正常运行 |
| 重启服务 | ✓ 通过 | 端口释放后可重启 |

**发现问题**:
- BUG-001: Python 模块相对导入失败 (已修复)

---

### 3. 服务状态测试 (`/archon-status`)

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 状态查询 | ✓ 通过 | 返回 running/tasks_count/scheduler_jobs |
| 任务统计 | ✓ 通过 | 正确显示任务数量 |
| 调度任务列表 | ✓ 通过 | 显示 job_id/next_run_time |

**发现问题**: 无

---

### 4. Probe 任务测试 (`/start-probe`)

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 任务创建 (首次) | ✗ 失败 | BUG-002: session-id 格式错误 |
| 任务创建 (修复后) | ✓ 通过 | task_id: 20260204_113007_probe |
| Claude CLI 启动 | ✓ 通过 | PID: 3413, UUID session_id |
| 任务执行 | ✓ 通过 | 成功分析 tt-pm-master 项目 |
| 输出记录 | ✓ 通过 | probe_stdout.log 包含完整结果 |
| 调度器注册 | ✓ 通过 | 5 分钟检查间隔 |

**测试任务**: 分析 tt-pm-master 项目亮点
**执行结果**: 成功输出项目亮点分析（8 个亮点）

**发现问题**:
- BUG-002: session-id 格式不符合 UUID 要求 (已修复)

---

### 5. Probe 状态检测测试 (`/check-task`)

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 运行中检测 | 未测试 | 任务快速完成，未能测试 |
| 完成后检测 | ✗ 失败 | BUG-003: 无法获取 transcript 路径 |
| 进程退出检测 | ✓ 通过 | 正确识别进程已退出 |
| stdout 分析 | ✗ 失败 | 未能从 stdout 判断完成状态 |

**发现问题**:
- BUG-003: Probe 完成后状态检测失败 (已修复)

---

### 6. Cron 任务测试 (`/start-cron`)

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 任务创建 | ✓ 通过 | task_id: 20260204_115154_cron |
| 配置保存 | ✓ 通过 | config.json, task.md, workflow/ |
| 调度器注册 | ✓ 通过 | 1 分钟间隔 |
| 定时触发 | ✓ 通过 | 按时触发执行 |
| Claude CLI 执行 | ✓ 通过 | 约 40 秒完成 |
| 结果解析 (首次) | ✗ 失败 | BUG-004: 状态始终为 unknown |
| 结果解析 (修复后) | ✓ 通过 | 正确解析 warning 状态 |
| 告警记录 | ✓ 通过 | 成功记录内存告警信息 |
| JSON 提取 | ✓ 通过 | 从 markdown 代码块提取 JSON |
| Metrics 解析 | ✓ 通过 | used_gb: 116, total_gb: 251 |

**测试任务**: 每分钟监控系统内存，超过 100GB 时记录
**执行结果**:
- 首次测试失败 (BUG-004)
- 修复后成功：`{"status": "warning", "summary": "内存使用超过100GB", "metrics": {...}}`

**发现问题**:
- BUG-004: Cron 任务执行结果解析失败 (已修复)
- 注意: 标准 cron 最小粒度为分钟，无法实现 30 秒间隔

---

### 7. 任务停止测试 (`/stop-cron`)

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 停止 Cron 任务 | ✓ 通过 | API 返回 success |
| 调度器移除 | ✓ 通过 | 任务从调度器移除 |
| 任务不再执行 | ✓ 通过 | 确认不再触发执行 |
| 日志记录 | ✓ 通过 | archon.log 记录停止操作 |
| status 文件更新 | ✓ 通过 | status 文件更新为 stopped |
| config.json 更新 | ✗ 失败 | BUG-005: state.status 未更新 |
| API 状态显示 | ✗ 失败 | /tasks 返回状态仍为 active |

**测试任务**: 停止内存监控测试任务
**执行结果**: 任务停止但状态显示不一致

**发现问题**:
- BUG-005: 停止任务后状态不一致 (待修复)

---

## 测试覆盖统计

| 功能模块 | 测试数 | 通过 | 失败 | 覆盖率 |
|----------|--------|------|------|--------|
| 环境初始化 | 7 | 7 | 0 | 100% |
| 服务启动 | 5 | 4 | 1 | 80% |
| 服务状态 | 3 | 3 | 0 | 100% |
| Probe 任务 | 6 | 5 | 1 | 83% |
| Probe 检测 | 4 | 2 | 2 | 50% |
| Cron 任务 | 10 | 8 | 2 | 80% |
| 任务停止 | 7 | 5 | 2 | 71% |
| **总计** | **42** | **34** | **8** | **81%** |

---

## 下一步推荐测试

### 高优先级 (P0)

#### 1. BUG-005 修复验证
- [ ] 修复 `set_task_status` 同步更新 config.json
- [ ] 验证停止任务后状态正确显示
- [ ] 验证 API `/tasks` 返回正确状态
- [ ] 测试 Probe 任务停止状态

#### 2. Cron 任务完整流程测试
- [ ] 测试 cron_expression 参数（如 `*/5 * * * *`）
- [ ] 测试任务超时处理
- [ ] 测试连续失败自动暂停机制
- [x] 测试手动执行 `/check-task` 触发 Cron (已完成)

### 中优先级 (P1)

#### 3. Probe 长时间运行测试
- [ ] 创建需要较长时间执行的 Probe 任务
- [ ] 测试定时检查是否正常触发
- [ ] 测试 transcript 增量读取
- [ ] 测试错误检测和自动纠偏

#### 4. 任务管理测试
- [ ] `/list-tasks` - 列出所有任务
- [ ] `/stop-probe <task_id>` - 停止 Probe 任务
- [ ] `/stop-cron <task_id>` - 停止 Cron 任务
- [ ] 任务暂停和恢复

#### 5. 通知系统测试
- [ ] 错误通知触发
- [ ] 完成通知触发
- [ ] 通知渠道配置（当前 notify-send 未安装）

### 低优先级 (P2)

#### 6. 边界条件测试
- [ ] 同时运行多个 Probe 任务
- [ ] 同时运行多个 Cron 任务
- [ ] 服务重启后任务恢复
- [ ] 磁盘空间不足时的行为

#### 7. 性能测试
- [ ] 大量任务时的调度性能
- [ ] 长时间运行的稳定性
- [ ] 内存占用监控

#### 8. API 接口测试
- [ ] `GET /tasks` - 任务列表筛选
- [ ] `GET /tasks/{task_id}` - 任务详情
- [ ] `POST /probe/{task_id}/check` - 手动检查
- [ ] `POST /cron/{task_id}/execute` - 手动执行
- [ ] `DELETE /tasks/{task_id}` - 删除任务

---

## 测试命令参考

```bash
# 环境检查
/archon-init

# 启动服务
/archon-start

# 查看状态
/archon-status

# 创建 Probe 任务
/start-probe <任务描述>

# 创建 Cron 任务
/start-cron <任务描述>

# 检查任务
/check-task <task_id>

# 查看任务列表
curl -s http://127.0.0.1:8765/tasks | python3 -m json.tool

# 查看任务详情
curl -s http://127.0.0.1:8765/tasks/<task_id> | python3 -m json.tool

# 查看服务日志
tail -f ~/.claude/daemon-archon/server.log

# 查看任务日志
tail -f ~/.claude/daemon-archon/<task_id>/archon.log
```

---

## 已发现 Bug 汇总

| 编号 | 标题 | 优先级 | 状态 | 修复日期 |
|------|------|--------|------|----------|
| BUG-001 | Python 模块相对导入失败导致服务无法启动 | P0 | [x] 已修复 | 2026-02-04 |
| BUG-002 | Probe 启动失败：session-id 格式不符合 UUID 要求 | P0 | [x] 已修复 | 2026-02-04 |
| BUG-003 | Probe 完成后状态检测失败：无法获取 transcript 路径 | P1 | [x] 已修复 | 2026-02-04 |
| BUG-004 | Cron 任务执行结果解析失败：状态始终为 unknown | P1 | [x] 已修复 | 2026-02-05 |
| BUG-005 | 停止任务后状态不一致：config.json 未更新 | P2 | [x] 已修复 | 2026-02-05 |

详细信息请参考 [bug.md](./bug.md)
